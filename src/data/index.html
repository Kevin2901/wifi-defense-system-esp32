<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wi-Fi Defender — Dashboard</title>
<link rel="icon" href="data:,">
<style>
  /* --------- Design tokens --------- */
  :root{
    --bg: #0f1724;         /* dark navy */
    --card: #0b1220;       /* deep card */
    --muted: #94a3b8;      /* muted text */
    --accent: linear-gradient(90deg,#7c3aed,#06b6d4);
    --glass: rgba(255,255,255,0.04);
    --good: #34d399;
    --warn: #f59e0b;
    --bad:  #fb7185;
    --glass-2: rgba(255,255,255,0.02);
  }
  /* --------- Reset --------- */
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#e6eef8;background:
    radial-gradient(1200px 400px at 10% 10%, rgba(3,7,18,0.6), transparent),
    linear-gradient(180deg,#071126 0%, #071324 60%, #041018 100%);}
  a{color:inherit}
  /* --------- Layout --------- */
  .wrap{max-width:1100px;margin:28px auto;padding:20px}
  header{display:flex;align-items:center;gap:18px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:54px;height:54px;border-radius:12px;background:linear-gradient(135deg,#0ea5ff,#7c3aed);display:flex;align-items:center;justify-content:center;box-shadow:0 6px 22px rgba(12,15,25,0.6)}
  .logo svg{filter:drop-shadow(0 6px 18px rgba(12,15,25,0.35))}
  h1{margin:0;font-size:20px}
  .subtitle{color:var(--muted);font-size:13px;margin-top:2px}
  .topControls{margin-left:auto;display:flex;gap:8px;align-items:center}
  .btn{background:linear-gradient(90deg,#0ea5ff,#7c3aed);border:0;color:#081221;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(124,58,237,0.12)}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px 10px;border-radius:10px;cursor:pointer}
  /* --------- Cards & grid --------- */
  .grid{display:grid;grid-template-columns: 320px 1fr;gap:16px;margin-top:18px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:14px;box-shadow:0 10px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
  .muted{color:var(--muted);font-size:13px}
  /* --------- Left column items --------- */
  .smallPanel{display:flex;flex-direction:column;gap:10px}
  .summary{display:flex;flex-direction:column;gap:6px}
  .stat{display:flex;align-items:center;gap:10px}
  .stat .num{font-weight:800;font-size:18px}
  .warnBadge{display:inline-flex;align-items:center;gap:8px;padding:8px;border-radius:10px;background:linear-gradient(90deg, rgba(251,113,133,0.08), rgba(245,158,11,0.04));border:1px solid rgba(251,113,133,0.06);color:var(--bad);font-weight:700}
  .searchRow{display:flex;gap:8px;align-items:center}
  .search{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:var(--glass);color:#e6eef8}
  .filterToggle{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass-2);color:var(--muted);cursor:pointer}
  /* --------- Table --------- */
  .tableWrap{overflow:auto}
  table{width:100%;border-collapse:collapse;font-size:13px;color:#cfe7ff}
  th,td{padding:10px 12px;text-align:left}
  thead th{color:var(--muted);font-weight:700;font-size:12px;letter-spacing:0.02em}
  tr{border-bottom:1px dashed rgba(255,255,255,0.03)}
  tr.suspicious{background:linear-gradient(90deg, rgba(255,235,238,0.04), transparent)}
  .ssid{font-weight:700;color:#ffffff}
  .bssid,.vendor{color:var(--muted);font-size:12px}
  .rssi{font-weight:800}
  .bars{display:inline-block;margin-left:8px;opacity:0.95}
  .badge{display:inline-block;padding:6px 8px;border-radius:999px;font-weight:700;font-size:12px}
  .secure{background:rgba(52,211,153,0.08);color:var(--good);border:1px solid rgba(52,211,153,0.04)}
  .warning{background:rgba(245,158,11,0.08);color:var(--warn);border:1px solid rgba(245,158,11,0.04)}
  .danger{background:rgba(251,113,133,0.08);color:var(--bad);border:1px solid rgba(251,113,133,0.04)}
  .flag{display:inline-block;padding:4px 6px;border-radius:8px;background:rgba(255,255,255,0.02);color:var(--muted);font-size:12px;margin-right:6px}
  /* --------- Details bar --------- */
  .footerBar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:14px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.02);color:var(--muted)}
  /* --------- responsive --------- */
  @media (max-width:900px){
    .grid{grid-template-columns:1fr; }
    .topControls{width:100%;justify-content:flex-end}
  }
  /* subtle animations */
  .fadeIn{animation:fadeIn .45s ease both}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none}}
</style>
</head>
<body>
  <div class="wrap fadeIn">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <!-- shield wifi icon -->
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 3C12 3 8 4.5 6 6C4 7.5 2 9.5 2 12C2 16 6 20 12 21C18 20 22 16 22 12C22 9.5 20 7.5 18 6C16 4.5 12 3 12 3Z" fill="#0b1220"/>
            <path d="M12 7.5C9.5 7.5 7.5 9.5 7.5 12C7.5 14.5 9.5 16.5 12 16.5C14.5 16.5 16.5 14.5 16.5 12C16.5 9.5 14.5 7.5 12 7.5Z" fill="#06b6d4"/>
            <path d="M12 9.5C10.8 9.5 9.8 10.5 9.8 11.7C9.8 12.9 10.8 13.9 12 13.9C13.2 13.9 14.2 12.9 14.2 11.7C14.2 10.5 13.2 9.5 12 9.5Z" fill="#7c3aed"/>
          </svg>
        </div>
        <div>
          <h1>Wi-Fi Defender</h1>
          <div class="subtitle">AP: <strong>WifiDefender</strong> · open <code>192.168.4.1</code></div>
        </div>
      </div>

      <div class="topControls">
        <button id="csvBtn" class="btn">Export CSV</button>
        <button id="darkBtn" class="ghost">Dark</button>
      </div>
    </header>

    <div class="grid">
      <!-- left column -->
      <div class="card smallPanel">
        <div class="summary">
          <div class="stat">
            <div>
              <div class="muted">Networks</div>
              <div class="num" id="netCount">—</div>
            </div>
            <div class="right">
              <div class="muted">Last update</div>
              <div id="lastUpdate" class="muted">—</div>
            </div>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <div class="warnBadge" id="warnBadge" style="display:none">
              <!-- alert icon -->
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M1 21h22L12 2 1 21z" fill="#fb7185"/></svg>
              <span id="warnSummary">0 Warnings</span>
            </div>
            <div style="margin-left:auto" class="muted">AP Mode</div>
          </div>
        </div>

        <div style="margin-top:10px">
          <div class="muted">Search & Filters</div>
          <div class="searchRow" style="margin-top:8px">
            <input id="search" class="search" placeholder="SSID or BSSID" />
            <button id="refreshBtn" class="filterToggle">Refresh</button>
          </div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="openOnly" class="filterToggle">Open only</button>
            <button id="strongOnly" class="filterToggle">Strong</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="muted">Threats</div>
          <div style="margin-top:8px" id="warningsArea">
            <div class="muted">No warnings detected</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="muted">Channel occupancy</div>
          <div id="channelSummary" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- right column -->
      <div>
        <div class="card tableWrap fadeIn">
          <table id="netTable" role="grid" aria-live="polite">
            <thead>
              <tr>
                <th>SSID</th>
                <th>BSSID</th>
                <th style="width:120px">Vendor</th>
                <th>Flags</th>
                <th>RSSI</th>
                <th>Ch</th>
                <th>Auth</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div class="footerBar">
            <div class="muted">Passive monitor • Local only</div>
            <div class="muted">Made with ♥ — ESP32</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------- Config ---------- */
const POLL = 4000;
let latest = [];
let warnings = [];

/* Small OUI map */
const OUI = {"24:5E:BE":"TP-Link","F0:9F:C2":"Netgear","A4:2B:B0":"Xiaomi","C0:3F:D5":"Cisco","28:6C:07":"Apple","70:EE:50":"Samsung"};
function vendorFromBssid(b){ if(!b) return "Unknown"; const k=b.toUpperCase().slice(0,8); return OUI[k]||"Unknown"; }
function rssiBars(r){ if(r>=-50) return "▮▮▮▮"; if(r>=-60) return "▮▮▮"; if(r>=-70) return "▮▮"; return "▮"; }
function authBadge(enc){ if(!enc) return `<span class="badge danger">UNK</span>`; if(enc==="OPEN") return `<span class="badge danger">OPEN</span>`; if(enc.includes("WEP")) return `<span class="badge warning">WEP</span>`; return `<span class="badge secure">WPA</span>`; }
function csvEscape(s){ if(s==null) return '""'; return '"'+String(s).replace(/"/g,'""')+'"'; }

/* ---------- UI helpers ---------- */
function setNetCount(n){ document.getElementById('netCount').textContent = n; }
function setLast(ts){ document.getElementById('lastUpdate').textContent = ts; }
function showWarnSummary(n){ const el=document.getElementById('warnBadge'); const txt=document.getElementById('warnSummary'); if(n>0){ el.style.display='inline-flex'; txt.textContent = `${n} Warning${n>1?'s':''}` } else el.style.display='none'; }

/* channel list */
function buildChannelSummary(arr){
  const counts = Array(15).fill(0);
  arr.forEach(x=>{ if(x.channel && x.channel>=1 && x.channel<=14) counts[x.channel]++ });
  const container = document.getElementById('channelSummary'); container.innerHTML='';
  const max = Math.max(...counts,1);
  for(let i=1;i<=14;i++){
    const w = Math.round((counts[i]/max)*100);
    const el = document.createElement('div');
    el.style.display='flex'; el.style.alignItems='center'; el.style.gap='10px'; el.style.marginBottom='6px';
    el.innerHTML = `<div style="width:36px;font-size:12px;color:var(--muted)">Ch ${i}</div>
      <div style="flex:1;height:8px;background:rgba(255,255,255,0.02);border-radius:6px;overflow:hidden">
        <div style="width:${w}%;height:100%;background:linear-gradient(90deg,#06b6d4,#7c3aed)"></div>
      </div>
      <div style="width:28px;text-align:right;color:var(--muted);font-size:12px">${counts[i]}</div>`;
    container.appendChild(el);
  }
}

/* render networks */
function renderTable(arr){
  const tbody = document.querySelector('#netTable tbody'); tbody.innerHTML='';
  const search = document.getElementById('search').value.trim().toLowerCase();
  const openOnly = document.getElementById('openOnly').classList.contains('active');
  const strongOnly = document.getElementById('strongOnly').classList.contains('active');

  let filtered = arr.filter(n=>{
    if(openOnly && n.encryption!=="OPEN") return false;
    if(strongOnly && (n.rssi===undefined || n.rssi<-60)) return false;
    if(search){
      const s=(n.ssid||'').toLowerCase(); const b=(n.bssid||'').toLowerCase();
      if(s.indexOf(search)===-1 && b.indexOf(search)===-1) return false;
    }
    return true;
  });

  // sort by rssi desc
  filtered.sort((a,b)=> (b.rssi||0) - (a.rssi||0));

  filtered.forEach(n=>{
    const tr = document.createElement('tr');
    if(n.suspect_takeover) tr.classList.add('suspicious');
    const flags = [];
    if(n.is_random_mac) flags.push('<span class="flag">Random MAC</span>');
    if(n.multi_bssid) flags.push('<span class="flag">Multi BSSID</span>');
    if(n.suspect_takeover) flags.push('<span class="flag">Takeover</span>');
    const vendor = n.vendor || vendorFromBssid(n.bssid);
    tr.innerHTML = `
      <td><div class="ssid">${n.ssid||'<hidden>'}</div><div class="bssid">${n.ssid? '': '(hidden SSID)'}</div></td>
      <td class="bssid">${n.bssid||''}</td>
      <td class="vendor">${vendor}</td>
      <td>${flags.join(' ')}</td>
      <td class="rssi">${n.rssi} <span class="bars">${rssiBars(n.rssi)}</span></td>
      <td>${n.channel||''}</td>
      <td>${authBadge(n.encryption)}</td>
    `;
    tbody.appendChild(tr);
  });

  setNetCount(filtered.length);
  buildChannelSummary(arr);
}

/* warnings area */
function showWarnings(list){
  const area = document.getElementById('warningsArea'); area.innerHTML='';
  if(!list || list.length===0){
    area.innerHTML = '<div class="muted">No warnings detected</div>';
    showWarnSummary(0);
    return;
  }
  const ul = document.createElement('div'); ul.style.display='flex'; ul.style.flexDirection='column'; ul.style.gap='8px';
  list.forEach(w=>{
    const el = document.createElement('div');
    el.style.padding='8px'; el.style.borderRadius='10px'; el.style.background='linear-gradient(90deg, rgba(255,255,255,0.012), rgba(255,255,255,0.01))'; el.style.border='1px solid rgba(255,255,255,0.02)';
    el.innerHTML = `<strong style="color:#fff">${w}</strong><div style="color:var(--muted);font-size:13px;margin-top:4px">${new Date().toLocaleTimeString()}</div>`;
    ul.appendChild(el);
  });
  area.appendChild(ul);
  showWarnSummary(list.length);
}

/* fetch /scan */
async function fetchScan(){
  try{
    const res = await fetch('/scan', {cache:'no-store'});
    const txt = await res.text();
    let obj={};
    try{ obj = JSON.parse(txt); }catch(e){ obj = {}; }
    const nets = obj.networks || [];
    latest = nets;
    warnings = obj.warnings || [];
    renderTable(nets);
    showWarnings(warnings);
    setLast(new Date().toLocaleTimeString());
  }catch(e){
    console.error(e);
    document.getElementById('lastUpdate').textContent = 'Error';
  }
}

/* CSV export */
function exportCSV(){
  if(!latest || latest.length===0){ alert('No data'); return; }
  const rows=[['SSID','BSSID','Vendor','RSSI','Channel','Encryption','Flags']];
  latest.forEach(n=>{
    const flags = [n.is_random_mac?'random':'',n.suspect_takeover?'takeover':'',n.multi_bssid?'multi':''].filter(Boolean).join('|');
    rows.push([n.ssid||'', n.bssid||'', n.vendor||vendorFromBssid(n.bssid), n.rssi||'', n.channel||'', n.encryption||'', flags]);
  });
  const csv = rows.map(r=> r.map(csvEscape).join(',')).join('\r\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='wifi_scan_'+Date.now()+'.csv'; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },500);
}

/* ---- events ---- */
document.getElementById('refreshBtn').addEventListener('click', fetchScan);
document.getElementById('csvBtn').addEventListener('click', exportCSV);
document.getElementById('search').addEventListener('input', ()=> renderTable(latest));
document.getElementById('openOnly').addEventListener('click', function(){ this.classList.toggle('active'); renderTable(latest); });
document.getElementById('strongOnly').addEventListener('click', function(){ this.classList.toggle('active'); renderTable(latest); });
document.getElementById('darkBtn').addEventListener('click', function(){ document.body.classList.toggle('light'); this.textContent = document.body.classList.contains('light') ? 'Dark' : 'Light'; });

/* start polling */
fetchScan();
setInterval(fetchScan, POLL);
</script>
</body>
</html>